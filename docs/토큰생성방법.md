# OAuth 토큰 생성 및 관리 방법

이 문서는 Claude Agent SDK와 Gemini CLI에서 OAuth 토큰을 생성하고 컨테이너 환경에서 관리하는 방법을 설명합니다.

> **중요**: API Key 방식은 사용량 기반 과금이 발생하므로 사용하지 않습니다. 기존 구독(Claude Pro/Max, Gemini Advanced)을 활용하기 위해 OAuth 인증만 사용합니다.

---

## 인증 방식 비교

| Provider | 인증 방식 | 환경변수 | 컨테이너 설정 |
|----------|----------|----------|--------------|
| **Claude** | Agent SDK + OAuth Token | `CLAUDE_CODE_OAUTH_TOKEN` | 환경변수로 전달 (권장) |
| **Gemini** | CLI + PTY Wrapper | 파일 마운트 | `~/.gemini/` 볼륨 마운트 |

---

## 1. Claude - OAuth 토큰 생성

### 1.1 Claude CLI 설치

```bash
# npm으로 설치
npm install -g @anthropic-ai/claude-code

# 또는 Python SDK 설치 (CLI 번들 포함)
pip install claude-agent-sdk
```

### 1.2 OAuth 토큰 생성

```bash
# 토큰 생성 명령어
claude setup-token
```

실행하면:
1. 브라우저가 열리고 Claude.ai 로그인 페이지로 이동
2. Claude Pro/Max 계정으로 로그인
3. 권한 승인 후 토큰이 터미널에 출력됨

### 1.3 토큰 저장 위치

| OS | 저장 위치 |
|----|-----------|
| macOS | macOS Keychain (암호화) |
| Linux | `~/.claude/.credentials.json` |
| Windows | `%APPDATA%\Claude\credentials.json` |

### 1.4 토큰 확인 방법

**Linux:**
```bash
cat ~/.claude/.credentials.json
```

**출력 예시:**
```json
{
  "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
  "expiresAt": 1736553600,
  "scopes": ["user:inference", "user:profile"]
}
```

**macOS:**
```bash
security find-generic-password -s "Claude" -w
```

### 1.5 환경변수 설정

```bash
# 토큰을 환경변수로 설정
export CLAUDE_CODE_OAUTH_TOKEN="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."

# 또는 .env 파일에 저장
echo "CLAUDE_CODE_OAUTH_TOKEN=your-token-here" >> .env
```

### 1.6 Docker/컨테이너 환경 설정

**방법 1: 환경변수 사용 (권장)**
```bash
docker run \
  -e CLAUDE_CODE_OAUTH_TOKEN="your-oauth-token" \
  llm-mcp-hub
```

**방법 2: .env 파일 사용**
```bash
# .env 파일
CLAUDE_CODE_OAUTH_TOKEN=your-oauth-token

# Docker 실행
docker run --env-file .env llm-mcp-hub
```

**docker-compose.yml:**
```yaml
services:
  llm-hub:
    image: llm-mcp-hub
    environment:
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis
```

### 1.7 Python SDK 사용 예시

```python
import os
import anyio
from claude_agent_sdk import query

# 환경변수에서 토큰 자동 로드
# CLAUDE_CODE_OAUTH_TOKEN이 설정되어 있어야 함

async def main():
    async for message in query(prompt="Hello, Claude!"):
        print(message)

anyio.run(main)
```

---

## 2. Gemini - OAuth 토큰 생성

### 2.1 Gemini CLI 설치

```bash
# npm으로 설치
npm install -g @google/gemini-cli
```

### 2.2 OAuth 인증

```bash
# Gemini CLI 실행
gemini

# 인증 방식 선택 메뉴:
# 1. Login with Google  ← 구독자용 (Advanced) 선택
# 2. Use Gemini API key
# 3. Vertex AI
```

**"Login with Google" 선택 후:**
1. 브라우저가 열리고 Google 계정 로그인 페이지로 이동
2. Gemini Advanced 구독된 계정으로 로그인
3. 권한 승인 후 토큰이 자동 저장됨

### 2.3 Headless 환경 (서버) 인증

브라우저가 없는 서버 환경에서는 URL 로거 워크어라운드를 사용합니다:

**Step 1: URL 로거 스크립트 생성**
```bash
# /usr/local/bin/url-logger.sh
#!/bin/bash
echo "$1" >> /tmp/gemini-auth-url.txt
echo "Auth URL saved to /tmp/gemini-auth-url.txt"
```

```bash
chmod +x /usr/local/bin/url-logger.sh
```

**Step 2: 환경변수 설정 후 gemini 실행**
```bash
export BROWSER=/usr/local/bin/url-logger.sh
gemini
```

**Step 3: URL 확인 및 로컬 브라우저에서 인증**
```bash
cat /tmp/gemini-auth-url.txt
# 출력된 URL을 로컬 컴퓨터 브라우저에서 열어 인증
```

### 2.4 토큰 저장 위치

| OS | 저장 위치 |
|----|-----------|
| macOS | `~/.gemini/oauth_creds.json` 또는 Keychain |
| Linux | `~/.gemini/oauth_creds.json` |
| Windows | `%APPDATA%\.gemini\oauth_creds.json` |

### 2.5 토큰 확인 방법

```bash
cat ~/.gemini/oauth_creds.json
```

**출력 예시:**
```json
{
  "access_token": "ya29.a0AfH6SMC...",
  "refresh_token": "1//0eXXXXXX...",
  "token_uri": "https://oauth2.googleapis.com/token",
  "expiry": "2026-01-10T12:00:00Z"
}
```

### 2.6 Docker/컨테이너 환경 설정

> **주의**: Gemini CLI는 OAuth 토큰용 환경변수를 지원하지 않습니다. **파일 마운트만 가능**합니다.

**방법: credentials 파일 마운트**
```bash
# 호스트에서 먼저 인증 수행
gemini  # "Login with Google" 선택 후 인증

# Docker 컨테이너에 마운트
docker run \
  -v ~/.gemini:/root/.gemini:ro \
  llm-mcp-hub
```

**docker-compose.yml:**
```yaml
services:
  llm-hub:
    image: llm-mcp-hub
    environment:
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - GEMINI_AUTH_PATH=/root/.gemini/oauth_creds.json
    volumes:
      - ~/.gemini:/root/.gemini:ro
    depends_on:
      - redis
```

### 2.7 PTY Wrapper 사용 이유

Gemini CLI는 **TTY(터미널)**가 필요합니다. 컨테이너에서 직접 subprocess로 호출하면 실패합니다.

```python
# ❌ 직접 subprocess 호출 - 실패
import subprocess
result = subprocess.run(["gemini", "-p", "Hello"], capture_output=True)
# TTY 없어서 hang 또는 에러

# ✅ PTY Wrapper 사용 - 성공
from ptyprocess import PtyProcess

proc = PtyProcess.spawn(["gemini", "-p", "Hello"])
output = ""
while proc.isalive():
    try:
        output += proc.read(1024).decode()
    except EOFError:
        break
print(output)
```

---

## 3. 토큰 유효 기간 및 갱신

### 3.1 토큰 유효 기간

| Provider | Access Token | Refresh Token | 권장 재인증 주기 |
|----------|--------------|---------------|-----------------|
| Claude | 1시간 | 수일~수주 | **1~2주** |
| Gemini | 1시간 | 수개월 | **2~4주** |

### 3.2 자동 갱신 동작

| 항목 | Claude | Gemini |
|------|--------|--------|
| Access Token 갱신 | SDK가 자동 처리 | CLI가 자동 처리 |
| Refresh Token 만료 | **수동 재인증 필요** | **수동 재인증 필요** |

### 3.3 토큰 갱신 스크립트

**refresh-claude-token.sh:**
```bash
#!/bin/bash
echo "=== Claude OAuth 토큰 갱신 ==="

# 1. 토큰 재생성
claude setup-token

# 2. 토큰 추출
TOKEN=$(cat ~/.claude/.credentials.json | jq -r '.accessToken')

# 3. 환경변수 업데이트 (.env 파일)
sed -i "s/CLAUDE_CODE_OAUTH_TOKEN=.*/CLAUDE_CODE_OAUTH_TOKEN=$TOKEN/" .env

echo "토큰이 갱신되었습니다."
```

**refresh-gemini-token.sh:**
```bash
#!/bin/bash
echo "=== Gemini OAuth 토큰 갱신 ==="

# 1. Gemini 재인증 (브라우저 필요)
gemini  # "Login with Google" 선택

# 2. 토큰 파일 확인
cat ~/.gemini/oauth_creds.json

echo "토큰이 갱신되었습니다. 컨테이너 재시작이 필요할 수 있습니다."
```

---

## 4. 컨테이너 환경 통합 설정

### 4.1 통합 docker-compose.yml

```yaml
version: '3.8'

services:
  llm-hub:
    image: llm-mcp-hub:latest
    ports:
      - "8000:8000"
    environment:
      # Claude - 환경변수로 토큰 전달
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN}
      - CLAUDE_MODEL=claude-sonnet-4-5-20250929

      # Gemini - 파일 경로 지정
      - GEMINI_AUTH_PATH=/root/.gemini/oauth_creds.json
      - GEMINI_MODEL=gemini-2.5-pro

      # Redis
      - REDIS_URL=redis://redis:6379

      # 로깅
      - LOG_LEVEL=INFO
    volumes:
      # Gemini OAuth 토큰 파일 마운트
      - ~/.gemini:/root/.gemini:ro
    depends_on:
      - redis
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped

volumes:
  redis-data:
```

### 4.2 .env.example

```bash
# Claude OAuth Token (필수)
# claude setup-token 명령어로 생성
CLAUDE_CODE_OAUTH_TOKEN=your-claude-oauth-token-here

# Claude Model (선택)
CLAUDE_MODEL=claude-sonnet-4-5-20250929

# Gemini Model (선택)
GEMINI_MODEL=gemini-2.5-pro

# Redis
REDIS_URL=redis://localhost:6379

# Logging
LOG_LEVEL=INFO
```

### 4.3 Dockerfile 예시

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 시스템 의존성
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Node.js 설치 (Gemini CLI용)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs

# Gemini CLI 설치
RUN npm install -g @google/gemini-cli

# Python 의존성
COPY pyproject.toml uv.lock ./
RUN pip install uv && uv sync

# 소스 코드
COPY src/ ./src/

# 환경변수 (런타임에 오버라이드)
ENV CLAUDE_CODE_OAUTH_TOKEN=""
ENV GEMINI_AUTH_PATH="/root/.gemini/oauth_creds.json"
ENV REDIS_URL="redis://localhost:6379"

EXPOSE 8000

CMD ["uv", "run", "uvicorn", "llm_mcp_hub.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## 5. 토큰 상태 모니터링

### 5.1 헬스체크 API

애플리케이션에서 `/health/tokens` 엔드포인트를 구현하여 토큰 상태를 모니터링합니다:

```
GET /health/tokens

Response:
{
  "claude": {
    "status": "valid",
    "expires_at": "2026-01-15T12:00:00Z",
    "days_remaining": 7
  },
  "gemini": {
    "status": "warning",
    "expires_at": "2026-01-12T12:00:00Z",
    "days_remaining": 3,
    "message": "Token expires soon, please refresh"
  }
}
```

### 5.2 알림 설정

토큰 만료 3일 전에 알림을 보내도록 설정합니다:

```python
# 토큰 만료 체크 로직 예시
from datetime import datetime, timedelta

def check_token_expiry(expires_at: datetime) -> dict:
    now = datetime.now()
    days_remaining = (expires_at - now).days

    if days_remaining <= 0:
        return {"status": "expired", "days_remaining": 0}
    elif days_remaining <= 3:
        return {"status": "warning", "days_remaining": days_remaining}
    else:
        return {"status": "valid", "days_remaining": days_remaining}
```

---

## 6. 비교 요약

| 항목 | Claude (Agent SDK) | Gemini (CLI + PTY) |
|------|-------------------|-------------------|
| 토큰 생성 명령 | `claude setup-token` | `gemini` (대화형) |
| 환경변수 지원 | `CLAUDE_CODE_OAUTH_TOKEN` | **지원 안함** |
| 컨테이너 설정 | 환경변수 (권장) | 파일 마운트 필수 |
| TTY 필요 여부 | **불필요** (SDK 사용) | **필요** (PTY 래퍼) |
| 토큰 파일 위치 | `~/.claude/.credentials.json` | `~/.gemini/oauth_creds.json` |
| 권장 갱신 주기 | 1~2주 | 2~4주 |

---

## 7. 트러블슈팅

### 7.1 Claude 토큰 문제

**문제: 토큰 설정 후에도 인증 요청됨**
```bash
# 환경변수 확인
echo $CLAUDE_CODE_OAUTH_TOKEN

# credentials 파일 삭제 후 재시도
rm -rf ~/.claude/.credentials.json
claude setup-token
```

**문제: "OAuth account information not found" 에러**
```bash
# 토큰 재생성
claude setup-token

# 환경변수 재설정
export CLAUDE_CODE_OAUTH_TOKEN="새로운-토큰"
```

### 7.2 Gemini 토큰 문제

**문제: Headless 환경에서 인증 실패**
```bash
# URL 로거 워크어라운드 사용
export BROWSER=/usr/local/bin/url-logger.sh
gemini
cat /tmp/gemini-auth-url.txt
# URL을 로컬 브라우저에서 열어 인증
```

**문제: Pro 모델 접근 불가 (Flash만 사용됨)**
- API Key가 아닌 OAuth 인증을 사용해야 Pro 모델 접근 가능
- `~/.gemini/oauth_creds.json` 파일이 올바르게 생성되었는지 확인

### 7.3 컨테이너 문제

**문제: Gemini 파일 마운트 실패**
```bash
# 권한 확인
ls -la ~/.gemini/

# 읽기 전용으로 마운트
docker run -v ~/.gemini:/root/.gemini:ro llm-mcp-hub
```

---

## 참고 자료

- [Claude Agent SDK - PyPI](https://pypi.org/project/claude-agent-sdk/)
- [Claude Agent SDK OAuth Demo](https://github.com/weidwonder/claude_agent_sdk_oauth_demo)
- [Claude Code - Identity and Access Management](https://code.claude.com/docs/en/iam)
- [Gemini CLI - npm](https://www.npmjs.com/package/@google/gemini-cli)
- [Gemini CLI - GitHub](https://github.com/google-gemini/gemini-cli)
- [Gemini CLI Headless Workaround](https://medium.com/@fourdollars/conquering-google-login-for-gemini-cli-on-headless-servers-3e9d2649790f)
- [ptyprocess - PyPI](https://pypi.org/project/ptyprocess/)
