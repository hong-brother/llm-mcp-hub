# Gemini PTY 복사본 테스트
FROM python:3.11-slim

ENV PYTHONUNBUFFERED=1

# 시스템 의존성
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Node.js + Gemini CLI
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g @google/gemini-cli \
    && rm -rf /var/lib/apt/lists/*

# Python 의존성
RUN pip install ptyprocess

WORKDIR /app

# 테스트 스크립트 (인증 파일 복사 후 실행)
COPY <<'EOF' /app/test_gemini_copy.py
import asyncio
import os
import re
import shutil
from pathlib import Path
from ptyprocess import PtyProcess

def setup_auth():
    """마운트된 인증 파일을 컨테이너 내부로 복사"""
    src = Path("/mnt/gemini-auth")
    dst = Path.home() / ".gemini"

    if not src.exists():
        print(f"[FAIL] 소스 경로 없음: {src}")
        return False

    # 기존 디렉토리 삭제 후 복사
    if dst.exists():
        shutil.rmtree(dst)

    shutil.copytree(src, dst)
    print(f"[OK] 인증 파일 복사 완료: {src} -> {dst}")

    # 파일 목록 확인
    for f in dst.iterdir():
        print(f"     - {f.name}")

    return True

def clean_ansi(text: str) -> str:
    return re.sub(r'\x1b\[[0-9;]*[a-zA-Z]', '', text)

def gemini_query(prompt: str, timeout: int = 60) -> str:
    import time

    proc = PtyProcess.spawn(
        ["gemini", "-p", prompt],
        env={**os.environ, "HOME": str(Path.home())},
        dimensions=(24, 200)
    )

    output = ""
    start = time.time()

    while proc.isalive():
        if time.time() - start > timeout:
            proc.terminate(force=True)
            raise TimeoutError("타임아웃")
        try:
            chunk = proc.read(1024)
            if chunk:
                output += chunk.decode('utf-8', errors='ignore')
        except EOFError:
            break

    proc.close()
    return clean_ansi(output).strip()

def main():
    print("=" * 50)
    print("Gemini PTY 복사본 테스트")
    print("=" * 50)

    # 1. 인증 파일 복사
    print("\n[1/2] 인증 파일 복사")
    if not setup_auth():
        print("[FAIL] 인증 파일 복사 실패")
        return

    # 2. Gemini 쿼리 테스트
    print("\n[2/2] Gemini 쿼리 테스트")
    prompt = "Say 'Hello from Docker!' in exactly those words."
    print(f"프롬프트: {prompt}")

    try:
        response = gemini_query(prompt)
        print(f"\n응답 길이: {len(response)} chars")

        # 에러 체크
        if "Error" in response or "error" in response.lower():
            print(f"[WARN] 에러 포함된 응답:")
            print(response[:500])
        else:
            print(f"[OK] 응답:")
            print(response[:500])

        # Hello 포함 여부 확인
        if "Hello" in response:
            print("\n[PASS] 'Hello' 키워드 확인됨 - 정상 동작!")
        else:
            print("\n[WARN] 'Hello' 키워드 없음 - 응답 확인 필요")

    except Exception as e:
        print(f"[FAIL] 쿼리 실패: {e}")

if __name__ == "__main__":
    main()
EOF

CMD ["python", "/app/test_gemini_copy.py"]
